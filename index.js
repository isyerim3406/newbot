import { chromium } from 'playwright';
import Jimp from 'jimp';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import axios from 'axios';
import FormData from 'form-data';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const screenshotsDir = path.join(__dirname, 'screenshots');
if (!fs.existsSync(screenshotsDir)) {
    fs.mkdirSync(screenshotsDir);
}

let lastResult = {
    timestamp: new Date().toISOString(),
    status: 'bekliyor',
    signal: 'yok',
    error: null,
    pixelColor: null,
    loginStatus: false
};

// Browser instance i√ßin
let browserInstance = null;
let pageInstance = null;

async function getBrowserInstance() {
    if (browserInstance && pageInstance) {
        try {
            // Test et browser hala √ßalƒ±≈üƒ±yor mu
            await pageInstance.evaluate(() => document.title);
            return { browser: browserInstance, page: pageInstance };
        } catch (error) {
            console.log('üîÑ Browser yeniden ba≈ülatƒ±lƒ±yor...');
            browserInstance = null;
            pageInstance = null;
        }
    }

    browserInstance = await chromium.launch({
        headless: true,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-accelerated-2d-canvas',
            '--disable-gpu',
            '--window-size=1920,1080',
            '--disable-web-security',
            '--disable-features=VizDisplayCompositor'
        ]
    });

    pageInstance = await browserInstance.newPage();
    
    // User agent ayarla
    await pageInstance.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
    await pageInstance.setViewportSize({ width: 1920, height: 1080 });

    return { browser: browserInstance, page: pageInstance };
}

// Telegram'a fotoƒüraf g√∂nderme (3 defa, 10 saniye arayla)
async function sendTelegramPhotos(filePath, caption) {
    const telegramBotToken = process.env.TELEGRAM_BOT_TOKEN;
    const telegramChatId = process.env.TELEGRAM_CHAT_ID;

    if (!telegramBotToken || !telegramChatId) {
        console.warn('‚ö†Ô∏è UYARI: TELEGRAM_BOT_TOKEN veya TELEGRAM_CHAT_ID ortam deƒüi≈ükenleri ayarlanmamƒ±≈ü.');
        return;
    }

    // 3 defa g√∂nder, 10 saniye arayla
    for (let i = 1; i <= 3; i++) {
        try {
            const formData = new FormData();
            formData.append('chat_id', telegramChatId);
            formData.append('caption', `${caption} (${i}/3)`);
            formData.append('photo', fs.createReadStream(filePath));

            await axios.post(`https://api.telegram.org/bot${telegramBotToken}/sendPhoto`, formData, {
                headers: formData.getHeaders()
            });
            
            console.log(`‚úì Telegram fotoƒüraf ${i}/3 g√∂nderildi`);
            
            // Son fotoƒüraf deƒüilse 10 saniye bekle
            if (i < 3) {
                await new Promise(resolve => setTimeout(resolve, 10000));
            }
        } catch (error) {
            console.error(`‚ùå Telegram fotoƒüraf ${i}/3 g√∂nderilirken hata:`, error.message);
        }
    }
}

// Telegram'a sinyal mesajƒ± g√∂nderme
async function sendTelegramMessage(message) {
    const telegramBotToken = process.env.TELEGRAM_BOT_TOKEN;
    const telegramChatId = process.env.TELEGRAM_CHAT_ID;

    if (!telegramBotToken || !telegramChatId) {
        return;
    }

    try {
        await axios.post(`https://api.telegram.org/bot${telegramBotToken}/sendMessage`, {
            chat_id: telegramChatId,
            text: message,
            parse_mode: 'HTML'
        });
        console.log('‚úì Telegram mesajƒ± g√∂nderildi');
    } catch (error) {
        console.error('‚ùå Telegram mesajƒ± g√∂nderilirken hata:', error.message);
    }
}

// TradingView login i≈ülemi
async function loginToTradingView(page) {
    console.log('üîê TradingView login i≈ülemi ba≈ülƒ±yor...');
    
    try {
        // Method 1: Environment credentials ile login
        const email = process.env.TRADINGVIEW_EMAIL;
        const password = process.env.TRADINGVIEW_PASSWORD;
        
        if (email && password) {
            console.log('üìß Email/Password ile giri≈ü deneniyor...');
            
            await page.goto('https://www.tradingview.com/accounts/signin/', {
                waitUntil: 'networkidle',
                timeout: 30000
            });

            try {
                await page.waitForSelector('input[name="username"]', { timeout: 15000 });
                await page.fill('input[name="username"]', email);
                await page.fill('input[name="password"]', password);
                
                const loginButton = await page.waitForSelector('button[type="submit"]', { timeout: 10000 });
                await loginButton.click();
                
                await page.waitForTimeout(5000);
                
                const isLoggedIn = await checkLoginStatus(page);
                if (isLoggedIn) {
                    console.log('‚úÖ Email/Password ile giri≈ü ba≈üarƒ±lƒ±!');
                    await saveCookiesForFuture(page);
                    return true;
                }
            } catch (error) {
                console.log('‚ùå Email/Password giri≈ü ba≈üarƒ±sƒ±z:', error.message);
            }
        }

        // Method 2: Base64 Cookies ile login
        const cookiesBase64 = process.env.COOKIES_BASE64;
        if (cookiesBase64) {
            console.log('üç™ Base64 cookies ile giri≈ü deneniyor...');
            
            try {
                await page.goto('https://www.tradingview.com/', {
                    waitUntil: 'domcontentloaded',
                    timeout: 30000
                });

                const cookiesString = Buffer.from(cookiesBase64, 'base64').toString('utf-8');
                const cookies = JSON.parse(cookiesString);
                
                // Cookies format d√∂n√º≈ü√ºm√º (Puppeteer ‚Üí Playwright)
                const playwrightCookies = cookies.map(cookie => ({
                    name: cookie.name,
                    value: cookie.value,
                    domain: cookie.domain,
                    path: cookie.path || '/',
                    httpOnly: cookie.httpOnly || false,
                    secure: cookie.secure || false,
                    sameSite: cookie.sameSite || 'Lax'
                }));
                
                await page.context().addCookies(playwrightCookies);
                console.log(`‚úì ${playwrightCookies.length} cookie y√ºklendi`);
                
                await page.reload({ waitUntil: 'networkidle' });
                
                const isLoggedIn = await checkLoginStatus(page);
                if (isLoggedIn) {
                    console.log('‚úÖ Cookies ile giri≈ü ba≈üarƒ±lƒ±!');
                    return true;
                }
                
            } catch (error) {
                console.log('‚ùå Base64 cookies giri≈ü ba≈üarƒ±sƒ±z:', error.message);
            }
        }

        // Method 3: JSON Cookies ile login
        const cookiesJson = process.env.TRADINGVIEW_COOKIES_JSON;
        if (cookiesJson) {
            console.log('üìù JSON cookies ile giri≈ü deneniyor...');
            
            try {
                await page.goto('https://www.tradingview.com/', {
                    waitUntil: 'domcontentloaded',
                    timeout: 30000
                });

                const cookies = JSON.parse(cookiesJson);
                await page.context().addCookies(cookies);
                
                await page.reload({ waitUntil: 'networkidle' });
                
                const isLoggedIn = await checkLoginStatus(page);
                if (isLoggedIn) {
                    console.log('‚úÖ JSON cookies ile giri≈ü ba≈üarƒ±lƒ±!');
                    return true;
                }
                
            } catch (error) {
                console.log('‚ùå JSON cookies giri≈ü ba≈üarƒ±sƒ±z:', error.message);
            }
        }

        console.log('‚ùå T√ºm login y√∂ntemleri ba≈üarƒ±sƒ±z - cookie olmadan devam ediliyor');
        return false;

    } catch (error) {
        console.error('‚ùå Login i≈ülemi genel hatasƒ±:', error.message);
        return false;
    }
}

// Login durumu kontrol√º
async function checkLoginStatus(page) {
    try {
        const loginSelectors = [
            '.tv-header__user-menu-button',
            '[data-name="header-user-menu-button"]',
            '.js-username',
            '.tv-dropdown-behavior__button--user',
            '[data-tooltip="User menu"]'
        ];

        for (const selector of loginSelectors) {
            try {
                const element = await page.$(selector);
                if (element && await element.isVisible()) {
                    console.log(`‚úÖ Login element bulundu: ${selector}`);
                    return true;
                }
            } catch (e) {
                continue;
            }
        }

        // URL kontrol√º
        const currentUrl = page.url();
        if (currentUrl.includes('/accounts/signin') || currentUrl.includes('/accounts/signup')) {
            return false;
        }

        return false;
    } catch (error) {
        return false;
    }
}

// Gelecek kullanƒ±m i√ßin cookies kaydet
async function saveCookiesForFuture(page) {
    try {
        const cookies = await page.context().cookies();
        const cookiesJson = JSON.stringify(cookies);
        const cookiesBase64 = Buffer.from(cookiesJson).toString('base64');
        
        console.log('üíæ Yeni cookies environment deƒüi≈ükenleri:');
        console.log('COOKIES_BASE64:', cookiesBase64.substring(0, 100) + '...');
    } catch (error) {
        console.error('‚ùå Cookies kaydetme hatasƒ±:', error);
    }
}

// Ana screenshot ve analiz fonksiyonu
async function takeChartScreenshot() {
    lastResult.status = '√ßalƒ±≈üƒ±yor';
    lastResult.timestamp = new Date().toISOString();

    const timestamp = Date.now();
    const screenshotPath = path.join(screenshotsDir, `screenshot_${timestamp}.png`);

    try {
        const { browser, page } = await getBrowserInstance();
        
        // Login kontrol√º ve i≈ülemi
        console.log('üîç Login durumu kontrol ediliyor...');
        let loginStatus = await checkLoginStatus(page);
        
        if (!loginStatus) {
            console.log('üîê Login gerekli, giri≈ü yapƒ±lƒ±yor...');
            loginStatus = await loginToTradingView(page);
        } else {
            console.log('‚úÖ Zaten giri≈ü yapƒ±lmƒ±≈ü');
        }
        
        lastResult.loginStatus = loginStatus;

        // Chart sayfasƒ±na git
        const chartUrl = 'https://www.tradingview.com/chart/?symbol=BINANCE:ETHUSDT.P&interval=1';
        console.log(`üìä Chart sayfasƒ±na gidiliyor: ${chartUrl}`);
        
        await page.goto(chartUrl, {
            waitUntil: 'domcontentloaded',
            timeout: 60000 
        });

        // Pop-up kapatma
        try {
            await page.waitForSelector('button[data-name="accept-recommended-settings"]', { timeout: 5000 });
            await page.click('button[data-name="accept-recommended-settings"]');
            console.log('‚úì Cookie pop-up kapatƒ±ldƒ±');
        } catch (e) {
            console.log('‚ÑπÔ∏è Cookie pop-up bulunamadƒ±');
        }

        // Chart elementini bekle
        console.log('üìà Chart elementi bekleniyor...');
        await page.waitForSelector('.chart-gui-wrapper', { timeout: 30000 });
        
        // ƒ∞ndikat√∂rlerin y√ºklenmesi i√ßin 5 saniye bekle
        console.log('‚è±Ô∏è ƒ∞ndikat√∂rlerin √ßizilmesi i√ßin 5 saniye bekleniyor...');
        await page.waitForTimeout(5000);

        // TAM EKRAN Screenshot al
        console.log('üì∏ Tam ekran screenshot alƒ±nƒ±yor...');
        await page.screenshot({ 
            path: screenshotPath,
            fullPage: true
        });
        
        console.log(`‚úÖ Screenshot kaydedildi: ${screenshotPath}`);

        // √ñnce screenshot'larƒ± g√∂nder (3 defa, 10 saniye arayla)
        await sendTelegramPhotos(screenshotPath, `üìä TradingView Screenshot\nüïê ${new Date().toLocaleString('tr-TR')}`);

        // Piksel analizi (koordinat bazlƒ± sinyal tespiti)
        console.log('üîç Sinyal analizi yapƒ±lƒ±yor...');
        const image = await Jimp.read(screenshotPath);
        
        // √ñrnek koordinatlar - bot kurulumunuza g√∂re ayarlayƒ±n
        const signalCoords = { x: 100, y: 100 }; // Bu koordinatlarƒ± ayarlayƒ±n
        const pixelColor = image.getPixelColor(signalCoords.x, signalCoords.y);
        const { r, g, b } = Jimp.intToRGBA(pixelColor);
        
        console.log(`üé® Piksel Rengi (${signalCoords.x}, ${signalCoords.y}): R:${r}, G:${g}, B:${b}`);

        // Sinyal belirleme
        let signal = 'sinyal yok';
        let signalEmoji = '‚ö™';
        
        if (r > 200 && g < 100 && b < 100) {
            signal = 'kƒ±rmƒ±zƒ±';
            signalEmoji = 'üî¥';
        } else if (g > 200 && r < 100 && b < 100) {
            signal = 'ye≈üil';
            signalEmoji = 'üü¢';
        }

        // Sinyal mesajƒ± g√∂nder
        const signalMessage = `
${signalEmoji} <b>Sƒ∞NYAL TESPƒ∞Tƒ∞</b> ${signalEmoji}

üìä <b>Sembol:</b> BINANCE:ETHUSDT.P
üéØ <b>Sinyal:</b> ${signal.toUpperCase()}
üé® <b>Renk:</b> R:${r}, G:${g}, B:${b}
üìç <b>Koordinat:</b> ${signalCoords.x}, ${signalCoords.y}
üïê <b>Tarih:</b> ${new Date().toLocaleString('tr-TR')}
üîê <b>Login:</b> ${loginStatus ? 'Ba≈üarƒ±lƒ±' : 'Ba≈üarƒ±sƒ±z'}
        `;

        await sendTelegramMessage(signalMessage);

        lastResult = {
            timestamp: new Date().toISOString(),
            status: 'ba≈üarƒ±lƒ±',
            signal: signal,
            error: null,
            pixelColor: { r, g, b },
            loginStatus: loginStatus
        };

        console.log(`‚úÖ Tarama tamamlandƒ±: ${signal}`);

    } catch (error) {
        console.error('‚ùå Tarama sƒ±rasƒ±nda hata:', error.message);
        
        lastResult = {
            timestamp: new Date().toISOString(),
            status: 'hata',
            signal: 'yok',
            error: error.message,
            pixelColor: null,
            loginStatus: false
        };

        // Hata durumunda screenshot al ve g√∂nder
        try {
            const { page } = await getBrowserInstance();
            const errorScreenshot = path.join(screenshotsDir, `error_${timestamp}.png`);
            await page.screenshot({ path: errorScreenshot, fullPage: true });
            
            const errorMessage = `
‚ùå <b>HATA OLU≈ûTU</b> ‚ùå

üö® <b>Hata:</b> ${error.message.substring(0, 200)}
üïê <b>Tarih:</b> ${new Date().toLocaleString('tr-TR')}
            `;
            
            await sendTelegramMessage(errorMessage);
            
        } catch (screenshotError) {
            console.error('‚ùå Hata screenshot alƒ±namadƒ±:', screenshotError.message);
        }

        throw error;
    }
}

// Health check endpoint (Render i√ßin)
import express from 'express';
const app = express();

app.get('/health', (req, res) => {
    res.json({
        status: 'healthy',
        message: 'TradingView Bot is running',
        timestamp: new Date().toISOString(),
        lastResult: lastResult
    });
});

app.get('/status', (req, res) => {
    res.json(lastResult);
});

const PORT = process.env.PORT || 8080;
app.listen(PORT, () => {
    console.log(`üåê Health server √ßalƒ±≈üƒ±yor: http://localhost:${PORT}`);
    console.log(`üìä Status: http://localhost:${PORT}/status`);
});

// Ana fonksiyon
const startBot = async () => {
    console.log('üöÄ TradingView Bot ba≈ülatƒ±lƒ±yor...');
    console.log('üíæ Environment deƒüi≈ükenleri kontrol ediliyor...');
    
    const requiredVars = ['TELEGRAM_BOT_TOKEN', 'TELEGRAM_CHAT_ID'];
    const missingVars = requiredVars.filter(varName => !process.env[varName]);
    
    if (missingVars.length > 0) {
        console.error(`‚ùå Eksik environment deƒüi≈ükenleri: ${missingVars.join(', ')}`);
        return;
    }

    console.log('‚úÖ Environment deƒüi≈ükenleri OK');
    
    try {
        // ƒ∞lk tarama
        console.log('üéØ ƒ∞lk tarama ba≈ülƒ±yor...');
        await takeChartScreenshot();
    } catch (e) {
        console.log(`‚ùå ƒ∞lk tarama ba≈üarƒ±sƒ±z: ${e.message}`);
    }

    // Periyodik tarama (10 dakika)
    setInterval(async () => {
        try {
            console.log('\nüîÑ Periyodik tarama ba≈ülƒ±yor...');
            await takeChartScreenshot();
        } catch (e) {
            console.log(`‚ùå Periyodik tarama ba≈üarƒ±sƒ±z: ${e.message}`);
        }
    }, 10 * 60 * 1000); // 10 dakika

    console.log('‚úÖ Bot ba≈üarƒ±yla ba≈ülatƒ±ldƒ± - 10 dakikada bir tarama yapƒ±lacak');
};

// Graceful shutdown
process.on('SIGTERM', async () => {
    console.log('üõë Bot kapatƒ±lƒ±yor...');
    if (browserInstance) {
        await browserInstance.close();
    }
    process.exit(0);
});

process.on('SIGINT', async () => {
    console.log('üõë Bot durduruldu...');
    if (browserInstance) {
        await browserInstance.close();
    }
    process.exit(0);
});

// Bot'u ba≈ülat
startBot();
